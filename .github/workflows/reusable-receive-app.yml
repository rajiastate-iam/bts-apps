name: Reusable - Receive Auth0 App (Create PR)

on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      app:
        required: true
        type: string
      env:
        required: true
        type: string
      yaml_path:
        required: true
        type: string
      src_repo:
        required: true
        type: string
      src_sha:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout auth0-apps
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout source repo at commit
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.src_repo }}
          ref: ${{ inputs.src_sha }}
          path: src
          fetch-depth: 1

      - name: Validate inputs
        shell: pwsh
        run: |
          $org     = "${{ inputs.org }}"
          $app     = "${{ inputs.app }}"
          $envName = "${{ inputs.env }}"
          $yamlRel = "${{ inputs.yaml_path }}"
          $srcRepo = "${{ inputs.src_repo }}"
          $srcSha  = "${{ inputs.src_sha }}"

          if ($org -match '[\/\\]') { throw "Invalid org (no slashes): $org" }
          if ($app -match '[\/\\]') { throw "Invalid app (no slashes): $app" }
          if ($envName -notmatch '^(dev|test|prod)$') { throw "env must be dev/test/prod. Got: $envName" }
          if ($yamlRel -notmatch '^apps\/.*\.ya?ml$') { throw "yaml_path must be under apps/*.yml|yaml. Got: $yamlRel" }
          if ($srcRepo -notmatch '^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+$') { throw "src_repo invalid: $srcRepo" }
          if ($srcSha -notmatch '^[0-9a-f]{7,40}$') { throw "src_sha invalid: $srcSha" }

          $full = Join-Path "src" $yamlRel
          if (-not (Test-Path $full)) { throw "YAML not found in source checkout: $full" }

          Write-Host "Validated input and file exists: $full"

      - name: Copy YAML into auth0-apps layout
        id: prep
        shell: pwsh
        run: |
          $org     = "${{ inputs.org }}"
          $app     = "${{ inputs.app }}"
          $envName = "${{ inputs.env }}".ToLower()
          $yamlRel = "${{ inputs.yaml_path }}"

          $srcFile = Join-Path "src" $yamlRel
          $dstDir  = Join-Path "apps" $org
          $dstFile = Join-Path $dstDir ("{0}-{1}.yaml" -f $app, $envName)

          New-Item -ItemType Directory -Force -Path $dstDir | Out-Null
          Copy-Item -Path $srcFile -Destination $dstFile -Force

          "target=$dstFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "Copied: $srcFile -> $dstFile"

      - name: Commit and push branch
        id: commit
        shell: pwsh
        run: |
          $org     = "${{ inputs.org }}"
          $app     = "${{ inputs.app }}"
          $envName = "${{ inputs.env }}".ToLower()
          $runId   = "${{ github.run_id }}"
          $branch  = "auto/$org-$app-$envName-$runId"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b $branch
          git add "${{ steps.prep.outputs.target }}"
          git commit -m "Auth0 app request: $org / $app / $envName"
          git push origin $branch

          "branch=$branch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "Pushed branch: $branch"

      - name: Open PR
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $org     = "${{ inputs.org }}"
          $app     = "${{ inputs.app }}"
          $envName = "${{ inputs.env }}".ToLower()

          $title = "Auth0 App Request: $org / $app / $envName"

          $bodyLines = @(
            "Automated Auth0 app registration request.",
            "",
            "Source repo: ${{ inputs.src_repo }}",
            "Commit:      ${{ inputs.src_sha }}",
            "Source file: ${{ inputs.yaml_path }}",
            "",
            "Target file: ${{ steps.prep.outputs.target }}"
          )
          $body = $bodyLines -join "`n"

          $payloadObj = @{
            title = $title
            head  = "${{ steps.commit.outputs.branch }}"
            base  = "master"
            body  = $body
          }
          $payloadJson = $payloadObj | ConvertTo-Json -Depth 6

          Invoke-RestMethod `
            -Method POST `
            -Uri "https://api.github.com/repos/${{ github.repository }}/pulls" `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            } `
            -Body $payloadJson

          Write-Host "PR created successfully."
