name: Publish Auth0 App (workflow_call)

on:
  push:
    branches:
      - main
    paths:
      - "apps/*.yaml"
      - "apps/*.yml"
  workflow_dispatch:
    inputs:
      file:
        description: "Optional: apps/<file>.yaml to publish"
        required: false
        type: string

permissions:
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      org: ${{ steps.meta.outputs.org }}
      app: ${{ steps.meta.outputs.app }}
      env: ${{ steps.meta.outputs.env }}
      yaml_path: ${{ steps.pick.outputs.file }}
      src_repo: ${{ github.repository }}
      src_sha: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pick changed YAML
        id: pick
        shell: pwsh
        run: |
          $eventName = "${{ github.event_name }}"
          $inputFile = "${{ inputs.file }}"

          if ($eventName -eq "workflow_dispatch") {
            if (-not $inputFile) { throw "workflow_dispatch requires inputs.file (example: apps/billing.yaml)" }
            $file = $inputFile.Trim()
            if ($file -notmatch '^apps\/.*\.ya?ml$') { throw "Invalid file path: $file" }
            if (-not (Test-Path $file)) { throw "File not found: $file" }
            "file=$file" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          $before = "${{ github.event.before }}"
          $after  = "${{ github.sha }}"
          Write-Host "Diffing $before..$after"

          $files = @(git diff --name-only $before $after | Where-Object { $_ -match '^apps\/.*\.ya?ml$' })

          if ($files.Count -eq 0) { throw "No apps/*.yml|yaml file changed." }
          if ($files.Count -ne 1) { throw "Expected exactly 1 apps/*.yml|yaml change, got $($files.Count):`n$($files -join "`n")" }

          "file=$($files[0])" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Read metadata (orgname/app/env)
        id: meta
        shell: pwsh
        run: |
          $file = "${{ steps.pick.outputs.file }}"
          Write-Host "Reading metadata from $file"

          if (-not (Get-Command ConvertFrom-Yaml -ErrorAction SilentlyContinue)) {
            Install-Module powershell-yaml -Scope CurrentUser -Force
          }
          Import-Module powershell-yaml

          $obj = (Get-Content $file -Raw) | ConvertFrom-Yaml

          if (-not $obj.orgname -or -not $obj.app -or -not $obj.env) {
            throw "Missing required keys (orgname/app/env) in $file"
          }

          "org=$($obj.orgname)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "app=$($obj.app)"     | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "env=$($obj.env)"     | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  call-auth0-apps:
    needs: detect
    uses: rajiastate-iam/auth0-apps/.github/workflows/reusable-receive-app.yml@master
    with:
      org: ${{ needs.detect.outputs.org }}
      app: ${{ needs.detect.outputs.app }}
      env: ${{ needs.detect.outputs.env }}
      yaml_path: ${{ needs.detect.outputs.yaml_path }}
      src_repo: ${{ needs.detect.outputs.src_repo }}
      src_sha: ${{ needs.detect.outputs.src_sha }}
