name: Publish Auth0 App to IAM (workflow_call, no secrets)

on:
  push:
    branches: [main]
    paths:
      - "apps/*.yaml"
      - "apps/*.yml"
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  detect-and-upload:
    runs-on: ubuntu-latest
    outputs:
      org: ${{ steps.meta.outputs.org }}
      app: ${{ steps.meta.outputs.app }}
      env: ${{ steps.meta.outputs.env }}
      file: ${{ steps.changed.outputs.file }}
      artifact_name: ${{ steps.art.outputs.name }}

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed app file
        id: changed
        shell: pwsh
        run: |
          $before = "${{ github.event.before }}"
          $after  = "${{ github.sha }}"
          Write-Host "Diffing $before..$after"

          $changed = @(git diff --name-only $before $after)
          $files = @($changed | Where-Object { $_ -match '^apps/.*\.ya?ml$' })

          if ($files.Count -eq 0) { throw "No apps/*.yml|yaml changed." }
          if ($files.Count -ne 1) { throw "Expected exactly 1 apps/*.yml|yaml file change, found $($files.Count)." }

          $file = $files[0].Trim()
          Write-Host "Using file: $file"
          "file=$file" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Read metadata from changed app file
        id: meta
        shell: pwsh
        run: |
          $file = "${{ steps.changed.outputs.file }}"

          if (-not (Get-Command ConvertFrom-Yaml -ErrorAction SilentlyContinue)) {
            Install-Module powershell-yaml -Scope CurrentUser -Force
            Import-Module powershell-yaml
          }

          $yaml = Get-Content $file -Raw
          $obj  = $yaml | ConvertFrom-Yaml

          if (-not $obj.orgname -or -not $obj.app -or -not $obj.env) {
            throw "Missing orgname/app/env in $file"
          }

          "org=$($obj.orgname)" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "app=$($obj.app)"     | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "env=$($obj.env)"     | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Prepare artifact
        id: art
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path /tmp/appreq | Out-Null
          Copy-Item "${{ steps.changed.outputs.file }}" /tmp/appreq/app.yaml -Force

          $name = "auth0-app-yaml-${{ github.run_id }}"
          "name=$name" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload YAML artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.art.outputs.name }}
          path: /tmp/appreq/app.yaml
          if-no-files-found: error

  call-auth0-apps:
    needs: detect-and-upload
    uses: rajiastate/auth0-apps/.github/workflows/reusable-receive-app.yml@master
    with:
      org: ${{ needs.detect-and-upload.outputs.org }}
      app: ${{ needs.detect-and-upload.outputs.app }}
      env: ${{ needs.detect-and-upload.outputs.env }}
      src_repo: ${{ github.repository }}
      src_sha: ${{ github.sha }}
      src_file: ${{ needs.detect-and-upload.outputs.file }}
      artifact_name: ${{ needs.detect-and-upload.outputs.artifact_name }}
