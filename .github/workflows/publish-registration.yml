name: Publish Auth0 Registration

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug-installation:
    runs-on: ubuntu-latest

    steps:
      - name: Show repo context
        shell: pwsh
        run: |
          Write-Host "Repo: $env:GITHUB_REPOSITORY"
          Write-Host "Actor: $env:GITHUB_ACTOR"

      - name: Validate org secrets are available (safe)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $appId = "${{ secrets.AUTH0_GHAPP_ID }}"
          $pkey  = "${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}"

          if ([string]::IsNullOrWhiteSpace($appId)) { throw "AUTH0_GHAPP_ID is EMPTY in this repo. Org secret not visible here." }
          if ([string]::IsNullOrWhiteSpace($pkey))  { throw "AUTH0_GHAPP_PRIVATE_KEY is EMPTY in this repo. Org secret not visible here." }

          Write-Host "AUTH0_GHAPP_ID present (length=$($appId.Length))"
          Write-Host "AUTH0_GHAPP_PRIVATE_KEY present (length=$($pkey.Length))"

          # Safe checks: header/footer existence only
          if ($pkey -notmatch "BEGIN (RSA )?PRIVATE KEY") { throw "Private key is missing BEGIN header (bad format/paste)." }
          if ($pkey -notmatch "END (RSA )?PRIVATE KEY")   { throw "Private key is missing END footer (bad format/paste)." }

          Write-Host "Private key header/footer look OK."

      - name: Check GitHub App installation exists on this repo (uses GITHUB_TOKEN)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"

          $repo = $env:GITHUB_REPOSITORY
          $uri  = "https://api.github.com/repos/$repo/installation"

          Write-Host "Checking installation endpoint: $uri"

          try {
            $resp = Invoke-RestMethod -Method GET -Uri $uri -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            }

            # If installed, GitHub returns installation object with id + app_id
            Write-Host "✅ Installation exists on this repo."
            Write-Host "installation.id: $($resp.id)"
            Write-Host "app_id:          $($resp.app_id)"
          }
          catch {
            Write-Host "❌ Installation lookup failed."
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode) {
              Write-Host "StatusCode: $($_.Exception.Response.StatusCode.value__)"
            }
            throw
          }

      - name: Mint GitHub App token via tibdex (ORG secrets)
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Show token success (safe)
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ steps.app-token.outputs.token }}")) {
            throw "Token output was empty"
          }
          Write-Host "✅ GitHub App token minted successfully."
