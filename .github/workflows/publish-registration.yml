name: Publish Auth0 App to IAM

on:
  push:
    # Only after merges to main in the apps repo
    branches:
      - main
    paths:
      - "apps/*.yaml"
      - "apps/*.yml"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools (yq & jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y yq jq

      # Find exactly ONE changed app file under apps/ in this push
      - name: Detect changed app file
        id: changed
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "Diffing $BEFORE..$AFTER to find changed app files"

          files=$(git diff --name-only "$BEFORE" "$AFTER" | grep '^apps/.*\.ya\?ml$' || true)

          if [ -z "$files" ]; then
            echo "No apps/*.yml|yaml files changed in this push. Nothing to do."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          count=$(echo "$files" | wc -l | tr -d ' ')
          echo "Changed app files:"
          echo "$files"

          if [ "$count" -ne 1 ]; then
            echo "ERROR: Expected exactly 1 apps/*.yml|yaml file to change, but found $count."
            echo "Please change only one app file per PR."
            exit 1
          fi

          file="$files"
          echo "Using file: $file"
          echo "file=$file" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Stop early if nothing to publish
        if: steps.changed.outputs.skip == 'true'
        run: echo "Skipping publish â€“ no app file changed."

      - name: Read metadata from changed app file
        if: steps.changed.outputs.skip != 'true'
        id: meta
        run: |
          FILE="${{ steps.changed.outputs.file }}"

          ORG=$(yq -r '.orgname' "$FILE")
          APP=$(yq -r '.app' "$FILE")
          ENV=$(yq -r '.env' "$FILE")

          if [ -z "$ORG" ] || [ -z "$APP" ] || [ -z "$ENV" ]; then
            echo "ERROR: orgname, app, or env is missing in $FILE"
            exit 1
          fi

          echo "org=$ORG"  >> "$GITHUB_OUTPUT"
          echo "app=$APP"  >> "$GITHUB_OUTPUT"
          echo "env=$ENV"  >> "$GITHUB_OUTPUT"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      # Clone IAM repo using the IAM PAT (only needs access to auth0-apps)
      - name: Clone IAM repo
        if: steps.changed.outputs.skip != 'true'
        env:
          IAM_TOKEN: ${{ secrets.IAM_REPO_TOKEN }}
        run: |
          git clone "https://x-access-token:${IAM_TOKEN}@github.com/rajiastate/auth0-apps.git" iam-repo
          cd iam-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Copy file into IAM repo layout and push a branch
      - name: Prepare branch and push to IAM repo
        if: steps.changed.outputs.skip != 'true'
        id: push_iam
        env:
          IAM_TOKEN: ${{ secrets.IAM_REPO_TOKEN }}
        run: |
          ORG="${{ steps.meta.outputs.org }}"
          APP="${{ steps.meta.outputs.app }}"
          ENV="${{ steps.meta.outputs.env }}"
          SRC_FILE="${{ steps.meta.outputs.file }}"

          BRANCH="auto/${ORG}-${APP}-${ENV}-${GITHUB_RUN_ID}"
          TARGET_FILE="apps/${ORG}/${APP}-${ENV}.yaml"

          echo "Branch: $BRANCH"
          echo "Target file in IAM repo: $TARGET_FILE"

          cd iam-repo
          git checkout -b "$BRANCH"

          mkdir -p "apps/${ORG}"
          cp "../${SRC_FILE}" "$TARGET_FILE"

          git add "$TARGET_FILE"
          git commit -m "Auth0 app registration: ${ORG} / ${APP} / ${ENV}"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "target_file=$TARGET_FILE" >> "$GITHUB_OUTPUT"

      # Open PR in IAM repo using GitHub REST API
      - name: Create PR in IAM repo
        if: steps.changed.outputs.skip != 'true'
        env:
          IAM_TOKEN: ${{ secrets.IAM_REPO_TOKEN }}
        run: |
          ORG="${{ steps.meta.outputs.org }}"
          APP="${{ steps.meta.outputs.app }}"
          ENV="${{ steps.meta.outputs.env }}"
          SRC_FILE="${{ steps.meta.outputs.file }}"
          BRANCH="${{ steps.push_iam.outputs.branch }}"

          TITLE="Auth0 App Request: ${ORG} / ${APP} / ${ENV}"
          BODY="Automated Auth0 app registration request.\n\nSource repo: ${GITHUB_REPOSITORY}\nCommit: ${GITHUB_SHA}\nApp file in apps repo: ${SRC_FILE}\nBranch in IAM repo: ${BRANCH}"

          # Build JSON for PR creation
          json=$(jq -n \
            --arg title "$TITLE" \
            --arg head "$BRANCH" \
            --arg base "master" \
            --arg body "$BODY" \
            '{title:$title, head:$head, base:$base, body:$body}')

          curl -sS -X POST \
            -H "Authorization: Bearer ${IAM_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/rajiastate/auth0-apps/pulls \
            -d "$json"
