name: Publish Auth0 App to IAM (GitHub App Token, No PAT)

on:
  push:
    branches: [main]
    paths:
      - "apps/*.yaml"
      - "apps/*.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed app file
        id: changed
        shell: pwsh
        run: |
          $before = "${{ github.event.before }}"
          $after  = "${{ github.sha }}"

          $changed = @(git diff --name-only $before $after)
          $files = @($changed | Where-Object { $_ -match '^apps/.*\.ya?ml$' })

          if ($files.Count -eq 0) {
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          if ($files.Count -ne 1) {
            throw "Expected exactly 1 apps/*.yml|yaml file change, found $($files.Count)."
          }

          $file = $files[0].Trim()
          "file=$file" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Read metadata from changed app file
        if: steps.changed.outputs.skip != 'true'
        id: meta
        shell: pwsh
        run: |
          $file = "${{ steps.changed.outputs.file }}"

          if (-not (Get-Command ConvertFrom-Yaml -ErrorAction SilentlyContinue)) {
            Install-Module powershell-yaml -Scope CurrentUser -Force
            Import-Module powershell-yaml
          }

          $yaml = Get-Content $file -Raw
          $obj  = $yaml | ConvertFrom-Yaml

          if (-not $obj.orgname -or -not $obj.app -or -not $obj.env) {
            throw "Missing orgname/app/env in $file"
          }

          "org=$($obj.orgname)" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "app=$($obj.app)"     | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "env=$($obj.env)"     | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "file=$file"          | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8

      # Mint a short-lived installation token for the GitHub App
      - name: Get GitHub App token
        if: steps.changed.outputs.skip != 'true'
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Dispatch request to pim-auth0
        if: steps.changed.outputs.skip != 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          IAM_OWNER: rajiastate
          IAM_REPO: auth0-apps
        run: |
          $payload = @{
            event_type = "auth0_app_request"
            client_payload = @{
              src_repo = "${{ github.repository }}"
              src_sha  = "${{ github.sha }}"
              src_file = "${{ steps.meta.outputs.file }}"
              org      = "${{ steps.meta.outputs.org }}"
              app      = "${{ steps.meta.outputs.app }}"
              env      = "${{ steps.meta.outputs.env }}"
            }
          } | ConvertTo-Json -Depth 6

          $uri = "https://api.github.com/repos/$($env:IAM_OWNER)/$($env:IAM_REPO)/dispatches"

          Invoke-RestMethod `
            -Method POST `
            -Uri $uri `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            } `
            -Body $payload
