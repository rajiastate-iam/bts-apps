
- name: Validate app policy
  shell: pwsh
  env:
    YAML_PATH: ${{ matrix.yaml_path }}
  run: |
    $ErrorActionPreference = "Stop"

    # Avoid interactive prompts on fresh runners
    try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
    Install-Module powershell-yaml -Scope CurrentUser -Force
    Import-Module powershell-yaml

    $path = $env:YAML_PATH
    $obj = (Get-Content $path -Raw) | ConvertFrom-Yaml

    $errors = @()
    $allowedConns = @("CustomersDB","azure-ad-prod")

    # Required keys
    foreach ($k in @("orgname","app","env","displayname","apptype","servicenow_req")) {
      if (-not $obj.$k) { $errors += "$($path): missing required key '$k'" }
    }

    # ServiceNow request format
    $snow = [string]$obj.servicenow_req
    if ($snow -and ($snow -notmatch '^REQ\d+$')) {
      $errors += "$($path): servicenow_req must match REQ<digits> (e.g., REQ0012345)"
    }

    # URL checks
    function Check-Urls($urls,$field) {
      foreach ($u in ($urls ?? @())) {
        try {
          $uri = [System.Uri]$u
          if ($uri.Scheme -ne "https") {
            $script:errors += "$($field): URL must use https -> $u"
          }
          $host = ($uri.Host ?? "").ToLower()
          if ($host -eq "localhost" -or $host -eq "127.0.0.1" -or $host.EndsWith(".local")) {
            $script:errors += "$($field): localhost/127.0.0.1/.local not allowed -> $u"
          }
        } catch {
          $script:errors += "$($field): invalid URL -> $u"
        }
      }
    }

    Check-Urls $obj.callbacks "callbacks"
    Check-Urls $obj.logouturls "logouturls"
    Check-Urls $obj.allowedorigins "allowedorigins"

    # Connections restriction
    $conns = @($obj.connections)
    $unknown = $conns | Where-Object { $_ -notin $allowedConns }
    if ($unknown.Count -gt 0) {
      $errors += "$($path): unsupported connections $($unknown -join ', '). Allowed: $($allowedConns -join ', ')"
    }
    if ($conns.Count -eq 0) {
      $errors += "$($path): 'connections' must include at least one of $($allowedConns -join ', ')"
    }

    if ($errors.Count -gt 0) {
      Write-Host "VALIDATION FAILED:"
      $errors | ForEach-Object { Write-Host " - $_" }
      exit 1
    } else {
      Write-Host "Validation passed âœ…"
    }
