name: Publish Auth0 Registration

on:
  push:
    branches: [main]
    paths:
      - "apps/**/*.yaml"
      - "apps/**/*.yml"

  workflow_dispatch:
    inputs:
      file:
        description: "Optional: single path like apps/<file>.yaml"
        required: false
        type: string

permissions:
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      files_json: ${{ steps.pick.outputs.files_json }}
      src_repo: ${{ github.repository }}
      src_sha: ${{ github.sha }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pick changed YAML files
        id: pick
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $eventName = "${{ github.event_name }}"
          $inputFile = "${{ inputs.file }}"
          $files = @()

          if ($eventName -eq "workflow_dispatch" -and -not [string]::IsNullOrWhiteSpace($inputFile)) {
            $file = $inputFile.Trim()
            if ($file -notmatch '^apps\/.*\.ya?ml$') { throw "Invalid file path: $file" }
            if (-not (Test-Path $file)) { throw "File not found: $file" }
            $files = @($file)
          }
          else {
            $before = "${{ github.event.before }}"
            $after  = "${{ github.sha }}"

            if ([string]::IsNullOrWhiteSpace($before) -or $before -eq "0000000000000000000000000000000000000000") {
              $before = "$(git rev-parse HEAD~1)"
            }

            Write-Host "Diffing $before..$after"
            $files = @(git diff --name-only $before $after |
              Where-Object { $_ -match '^apps\/.*\.ya?ml$' } |
              ForEach-Object { $_.Trim() })
          }

          if ($files.Count -eq 0) { throw "No apps YAML files changed." }

          $files = $files | Sort-Object -Unique
          $files = @($files)

          Write-Host "Selected YAML files:"
          $files | ForEach-Object { Write-Host " - $_" }

          $json = "[" + (($files | ForEach-Object { '"' + ($_ -replace '"','\"') + '"' }) -join ",") + "]"
          "files_json=$json" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  dispatch:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        yaml_path: ${{ fromJson(needs.detect.outputs.files_json) }}

    steps:
      - name: Validate org secrets are available (safe)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $appId = "${{ secrets.AUTH0_GHAPP_ID }}"
          $pkey  = "${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}"

          if ([string]::IsNullOrWhiteSpace($appId)) { throw "AUTH0_GHAPP_ID is EMPTY in this repo. Org secret not visible here." }
          if ([string]::IsNullOrWhiteSpace($pkey))  { throw "AUTH0_GHAPP_PRIVATE_KEY is EMPTY in this repo. Org secret not visible here." }

          if ($pkey -notmatch "BEGIN (RSA )?PRIVATE KEY") { throw "Private key missing BEGIN header." }
          if ($pkey -notmatch "END (RSA )?PRIVATE KEY")   { throw "Private key missing END footer." }

          Write-Host "Secrets present; key header/footer OK."

      - name: Check GitHub App installation exists on THIS repo (via gh api using github.token)
        shell: pwsh
        env:
          GITHUB_TOKEN_FOR_API: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"

          $repo = $env:GITHUB_REPOSITORY
          Write-Host "Checking installation via gh for repo: $repo"

          # IMPORTANT: explicitly provide token to gh (do NOT rely on GH_TOKEN env)
          $out = gh api "repos/$repo/installation" --header "Authorization: Bearer $env:GITHUB_TOKEN_FOR_API" 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host $out
            throw "Installation lookup failed via gh api."
          }

          Write-Host $out

      - name: Mint GitHub App token via tibdex (ORG secrets)
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Dispatch request to auth0-apps (via gh api using App token)
        shell: pwsh
        env:
          TARGET_REPO: rajiastate-iam/auth0-apps
        run: |
          $ErrorActionPreference = "Stop"

          $appToken = "${{ steps.app-token.outputs.token }}"
          if ([string]::IsNullOrWhiteSpace($appToken)) { throw "GitHub App token is empty." }

          $yamlPath   = "${{ matrix.yaml_path }}"
          $srcRepo    = "${{ needs.detect.outputs.src_repo }}"
          $srcSha     = "${{ needs.detect.outputs.src_sha }}"
          $targetRepo = $env:TARGET_REPO

          if ($yamlPath -notmatch '^apps\/.*\.ya?ml$') { throw "Invalid yaml_path: $yamlPath" }

          Write-Host "Dispatching $yamlPath from $srcRepo@$srcSha to $targetRepo"

          $out = gh api "repos/$targetRepo/dispatches" `
            -X POST `
            --header "Authorization: token $appToken" `
            --header "Accept: application/vnd.github+json" `
            -f "event_type=auth0_app_request" `
            -f "client_payload[src_repo]=$srcRepo" `
            -f "client_payload[src_sha]=$srcSha" `
            -f "client_payload[yaml_path]=$yamlPath" 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Host $out
            throw "Dispatch failed via gh api."
          }

          Write-Host "âœ… Dispatch sent."
