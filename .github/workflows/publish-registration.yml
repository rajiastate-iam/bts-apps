name: Publish Auth0 Registration

on:
  push:
    branches: [main]
    paths:
      - "apps/*.yaml"
      - "apps/*.yml"

  workflow_dispatch:
    inputs:
      file:
        description: "Optional: single path like apps/<file>.yaml"
        required: false
        type: string

permissions:
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      files_json: ${{ steps.pick.outputs.files_json }}
      src_repo: ${{ github.repository }}
      src_sha: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pick changed YAML files
        id: pick
        shell: pwsh
        run: |
          $eventName = "${{ github.event_name }}"
          $inputFile = "${{ inputs.file }}"

          $files = @()

          if ($eventName -eq "workflow_dispatch" -and -not [string]::IsNullOrWhiteSpace($inputFile)) {
            $file = $inputFile.Trim()
            if ($file -notmatch '^apps\/.*\.ya?ml$') { throw "Invalid file path: $file" }
            if (-not (Test-Path $file)) { throw "File not found: $file" }
            $files = @($file)
          }
          else {
            $before = "${{ github.event.before }}"
            $after  = "${{ github.sha }}"

            if ([string]::IsNullOrWhiteSpace($before) -or $before -eq "0000000000000000000000000000000000000000") {
              $before = "$(git rev-parse HEAD~1)"
            }

            $files = @(git diff --name-only $before $after | Where-Object { $_ -match '^apps\/.*\.ya?ml$' } | ForEach-Object { $_.Trim() })
          }

          if ($files.Count -eq 0) { throw "No apps YAML files changed." }

          # de-dupe + sort
          $files = $files | Sort-Object -Unique

          # ✅ Force array even when there is one item
          $files = @($files)

          Write-Host "Files selected:"
          $files | ForEach-Object { Write-Host " - $_" }

          # ✅ Build a guaranteed JSON array string
          $json = "[" + (($files | ForEach-Object { '"' + ($_ -replace '"','\"') + '"' }) -join ",") + "]"
          Write-Host "files_json=$json"

          "files_json=$json" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  call-auth0-apps:
    needs: detect

    strategy:
      fail-fast: false
      matrix:
        yaml_path: ${{ fromJson(needs.detect.outputs.files_json) }}

    permissions:
      contents: read

    uses: rajiastate-iam/auth0-apps/.github/workflows/reusable-receive-app.yml@master

    secrets:
      AUTH0_GHAPP_ID: ${{ secrets.AUTH0_GHAPP_ID }}
      AUTH0_GHAPP_PRIVATE_KEY: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

    with:
      src_repo:  ${{ needs.detect.outputs.src_repo }}
      src_sha:   ${{ needs.detect.outputs.src_sha }}
      yaml_path: ${{ matrix.yaml_path }}
